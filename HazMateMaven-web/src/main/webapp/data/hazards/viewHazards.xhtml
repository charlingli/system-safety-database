<?xml version='1.0' encoding='UTF-8' ?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml"
      xmlns:ui="http://xmlns.jcp.org/jsf/facelets"
      xmlns:h="http://xmlns.jcp.org/jsf/html"
      xmlns:p="http://primefaces.org/ui"
      xmlns:f="http://xmlns.jcp.org/jsf/core">
    <body>
        <ui:composition template="./../../templates/masterTemplate.xhtml">
            <ui:define name="content">
                <h:form id="hazardsForm" onclick="closeRating();">
                    <p:hotkey bind="esc" handler="PF('ratingOverlay').hide()"/>
                    <p:hotkey bind="esc" actionListener="#{hazardView_MB.refreshRating()}"/>
                    <div class="pagePath"><h:outputText value="#{pagePath_MB.pageHtmlPath}" escape="false"/></div>
                    <ui:include src="../../templates/detailDialog.xhtml"/>
                    <ui:include src="../../templates/spinnerDialog.xhtml"/>
                    <p:dialog id="bowtieDialog" header="Bowtie Diagram" widgetVar="bowtieOverlay" height="70vh" width="90vw" closeOnEscape="true">
                        <p:panel class="visPanel">
                            <div class="visCanvas">
                                <div id="graphic"></div>
                                <div class="left">
                                    <ui:repeat value="${hazardViewVis_MB.selectedCauses}" var="CA" varStatus="status">
                                        <div>
                                            <h:outputText value="${CA.dbCause.causeDescription}"> </h:outputText>
                                        </div>
                                    </ui:repeat>
                                </div>
                                <div class="mid">
                                    <div class="top">
                                        <div class="label">
                                            Current Risk:
                                        </div>
                                        <div class="risk">
                                            <div class="frequency">
                                                <h:outputText value="${hazardViewVis_MB.selectedHazard.riskCurrentFrequencyId.frequencyScore}"> </h:outputText>
                                            </div>
                                            <div class="severity">
                                                <h:outputText value="${hazardViewVis_MB.selectedHazard.riskCurrentSeverityId.severityScore}"> </h:outputText>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="center">
                                        <h:outputText value="${hazardViewVis_MB.selectedDescription}"> </h:outputText>
                                    </div>
                                    <div class="bottom">
                                        <div class="label">
                                            Targeted Risk:
                                        </div>
                                        <div class="risk">
                                            <div class="frequency">
                                                <h:outputText value="${hazardViewVis_MB.selectedHazard.riskTargetFrequencyId.frequencyScore}"> </h:outputText>
                                            </div>
                                            <div class="severity">
                                                <h:outputText value="${hazardViewVis_MB.selectedHazard.riskTargetSeverityId.severityScore}"> </h:outputText>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div class="right">
                                    <ui:repeat value="${hazardViewVis_MB.selectedConsequences}" var="CQ" varStatus="status">
                                        <div>
                                            <h:outputText value="${CQ.dbConsequence.consequenceDescription}"> </h:outputText>
                                        </div>
                                    </ui:repeat>
                                </div>
                                <div class="between">
                                    <div class="mid-left">
                                        <ui:repeat value="${hazardViewVis_MB.selectedPControls}" var="PC" varStatus="status">
                                            <div>
                                                <div class="marker"></div>
                                                <div class="text">
                                                    <h:outputLink id="PCEntry" value="#">
                                                        <h:outputText value="#{PC.dbControl.controlDescription}"/>
                                                    </h:outputLink>
                                                    <p:tooltip for="PCEntry" value="#{PC.dbControl.controlDescription}" trackMouse="true"/>
                                                </div>
                                                <div class="status">
                                                    <h:outputLink id="PCJustify" value="#">
                                                        <h:outputText value="#{PC.controlRecommendId.controlRecommendName}"/>
                                                    </h:outputLink>
                                                    <p:tooltip for="PCJustify" value="#{PC.controlJustify}" trackMouse="true"/>
                                                </div>
                                            </div>
                                        </ui:repeat>
                                    </div>
                                    <div class="mid-right">
                                        <ui:repeat value="${hazardViewVis_MB.selectedMControls}" var="MC" varStatus="status">
                                            <div>
                                                <div class="marker"></div>
                                                <div class="text">
                                                    <h:outputLink id="MCEntry" value="#">
                                                        <h:outputText value="#{MC.dbControl.controlDescription}"/>
                                                    </h:outputLink>
                                                    <p:tooltip for="MCEntry" value="#{MC.dbControl.controlDescription}" trackMouse="true"/>
                                                </div>
                                                <div class="status">
                                                    <h:outputLink id="MCJustify" value="#">
                                                        <h:outputText value="#{MC.controlRecommendId.controlRecommendName}"/>
                                                    </h:outputLink>
                                                    <p:tooltip for="MCJustify" value="#{MC.controlJustify}" trackMouse="true"/>
                                                </div>
                                            </div>
                                        </ui:repeat>
                                    </div>
                                </div>
                            </div>
                        </p:panel>
                    </p:dialog>
                    <p:fieldset id="fieldset" legend="Search parameters" toggleable="true" toggleSpeed="1000" styleClass="searchFieldset" collapsed="true">
                        <h:panelGrid columns="2" columnClasses="fields,explanation">
                            <p:accordionPanel id="searchFields" multiple="true" class="searchAccordion" activeIndex="null">
                                <p:tab title="Hazard Fields">
                                    <p:panel styleClass="searchPanel">
                                        <p:panelGrid columns="3" columnClasses="left,middle,right">
                                            <p:outputLabel>Hazard Id:</p:outputLabel>
                                            <p:inputText id="HiDInput" value="#{hazardView_MB.searchedHazardId}">
                                                <p:ajax event="keyup" update="HiDClear"/>
                                            </p:inputText>
                                            <h:panelGroup styleClass="remove">
                                                <p:commandLink id="HiDClear" update="hazardsForm:fieldset" action="#{hazardView_MB.clearField(component.id)}" process="@this" rendered="#{not empty hazardView_MB.searchedHazardId}">
                                                    <i class="fa fa-remove"/>
                                                </p:commandLink>
                                            </h:panelGroup>
                                            <p:outputLabel>Hazard Description:</p:outputLabel>
                                            <p:inputText id="HDInput" value="#{hazardView_MB.searchedHazardDescription}">
                                                <p:ajax event="keyup" update="HDClear"/>
                                            </p:inputText>
                                            <h:panelGroup styleClass="remove">
                                                <p:commandLink id="HDClear" update="hazardsForm:fieldset" action="#{hazardView_MB.clearField(component.id)}" process="@this" rendered="#{not empty hazardView_MB.searchedHazardDescription}">
                                                    <i class="fa fa-remove"/>
                                                </p:commandLink>
                                            </h:panelGroup>
                                            <p:outputLabel>Hazard Causes:</p:outputLabel>
                                            <p:inputText id="CAInput" value="#{hazardView_MB.searchedCauses}">
                                                <p:ajax event="keyup" update="CAClear"/>
                                            </p:inputText>
                                            <h:panelGroup styleClass="remove">
                                                <p:commandLink id="CAClear" update="hazardsForm:fieldset" action="#{hazardView_MB.clearField(component.id)}" process="@this" rendered="#{not empty hazardView_MB.searchedCauses}"> 
                                                    <i class="fa fa-remove"/>
                                                </p:commandLink>
                                            </h:panelGroup>
                                            <p:outputLabel>Hazard Consequences:</p:outputLabel>
                                            <p:inputText id="CQInput" value="#{hazardView_MB.searchedConsequences}">
                                                <p:ajax event="keyup" update="CQClear"/>
                                            </p:inputText>
                                            <h:panelGroup styleClass="remove">
                                                <p:commandLink id="CQClear" update="hazardsForm:fieldset" action="#{hazardView_MB.clearField(component.id)}" process="@this" rendered="#{not empty hazardView_MB.searchedConsequences}"> 
                                                    <i class="fa fa-remove"/>
                                                </p:commandLink>
                                            </h:panelGroup>
                                            <p:outputLabel>Hazard Comments:</p:outputLabel>
                                            <p:inputText id="HMInput" value="#{hazardView_MB.searchedHazardComments}">
                                                <p:ajax event="keyup" update="HMClear"/>
                                            </p:inputText>
                                            <h:panelGroup styleClass="remove">
                                                <p:commandLink id="HMClear" update="hazardsForm:fieldset" action="#{hazardView_MB.clearField(component.id)}" process="@this" rendered="#{not empty hazardView_MB.searchedHazardComments}"> 
                                                    <i class="fa fa-remove"/>
                                                </p:commandLink>
                                            </h:panelGroup>
                                            <p:outputLabel>Hazard Legacy Id:</p:outputLabel>
                                            <p:inputText id="HLiDInput" value="#{hazardView_MB.searchedLegacyId}">
                                                <p:ajax event="keyup" update="HLiDClear"/>
                                            </p:inputText>
                                            <h:panelGroup styleClass="remove">
                                                <p:commandLink id="HLiDClear" update="hazardsForm:fieldset" action="#{hazardView_MB.clearField(component.id)}" process="@this" rendered="#{not empty hazardView_MB.searchedLegacyId}"> 
                                                    <i class="fa fa-remove"/>
                                                </p:commandLink>
                                            </h:panelGroup>
                                            <p:outputLabel>Hazard Location:</p:outputLabel>
                                            <p:selectCheckboxMenu class="searchInput" id="HLInput" value="#{hazardView_MB.selectedLocations}" label="Hazard Locations" filter="true" filterMatchMode="contains">
                                                <f:selectItems value="#{hazardView_MB.listLocations}" var="location" itemLabel="#{location.locationName}" itemValue="#{location.locationId}"/>
                                            </p:selectCheckboxMenu>
                                            <h:panelGroup styleClass="remove">
                                                <p:commandLink id="HLClear" update="hazardsForm:fieldset" action="#{hazardView_MB.clearField(component.id)}" process="@this" rendered="#{not empty hazardView_MB.selectedLocations}"> 
                                                    <i class="fa fa-remove"/>
                                                </p:commandLink>
                                            </h:panelGroup>
                                            <p:outputLabel>Hazard Project:</p:outputLabel>
                                            <p:selectCheckboxMenu class="searchInput" id="HPInput" value="#{hazardView_MB.selectedProjects}" label="Hazard Projects" filter="true" filterMatchMode="contains">
                                                <f:selectItems value="#{hazardView_MB.listProjects}" var="project" itemLabel="#{project.projectName}" itemValue="#{project.projectId}"/>
                                            </p:selectCheckboxMenu>
                                            <h:panelGroup styleClass="remove">
                                                <p:commandLink id="HPClear" update="hazardsForm:fieldset" action="#{hazardView_MB.clearField(component.id)}" process="@this" rendered="#{not empty hazardView_MB.selectedProjects}"> 
                                                    <i class="fa fa-remove"/>
                                                </p:commandLink>
                                            </h:panelGroup>
                                            <p:outputLabel>Grade Separation:</p:outputLabel>
                                            <p:selectCheckboxMenu class="searchInput" id="GSInput" value="#{hazardView_MB.selectedGradeSeparations}" label="Grade Separations" filter="true" filterMatchMode="contains">
                                                <f:selectItems value="#{hazardView_MB.listGradeSeparations}" var="gradeSeparation" itemLabel="#{gradeSeparation.gradeSeparationName}" itemValue="#{gradeSeparation.gradeSeparationId}"/>
                                            </p:selectCheckboxMenu>
                                            <h:panelGroup styleClass="remove">
                                                <p:commandLink id="GSClear" update="hazardsForm:fieldset" action="#{hazardView_MB.clearField(component.id)}" process="@this" rendered="#{not empty hazardView_MB.selectedGradeSeparations}"> 
                                                    <i class="fa fa-remove"/>
                                                </p:commandLink>
                                            </h:panelGroup>
                                            <p:outputLabel>Construction Type:</p:outputLabel>
                                            <p:selectCheckboxMenu class="searchInput" id="CNInput" value="#{hazardView_MB.selectedConstructionTypes}" label="Construction Types" filter="true" filterMatchMode="contains">
                                                <f:selectItems value="#{hazardView_MB.listConstructionTypes}" var="constructionType" itemLabel="#{constructionType.constructionTypeName}" itemValue="#{constructionType.constructionTypeId}"/>
                                            </p:selectCheckboxMenu>
                                            <h:panelGroup styleClass="remove">
                                                <p:commandLink id="CNClear" update="hazardsForm:fieldset" action="#{hazardView_MB.clearField(component.id)}" process="@this" rendered="#{not empty hazardView_MB.selectedConstructionTypes}"> 
                                                    <i class="fa fa-remove"/>
                                                </p:commandLink>
                                            </h:panelGroup>
                                            <p:outputLabel>Change Type:</p:outputLabel>
                                            <p:selectCheckboxMenu class="searchInput" id="CHInput" value="#{hazardView_MB.selectedChangeTypes}" label="Change Types" filter="true" filterMatchMode="contains">
                                                <f:selectItems value="#{hazardView_MB.listChangeTypes}" var="changeType" itemLabel="#{changeType.changeTypeName}" itemValue="#{changeType.changeTypeId}"/>
                                            </p:selectCheckboxMenu>
                                            <h:panelGroup styleClass="remove">
                                                <p:commandLink id="CHClear" update="hazardsForm:fieldset" action="#{hazardView_MB.clearField(component.id)}" process="@this" rendered="#{not empty hazardView_MB.selectedChangeTypes}"> 
                                                    <i class="fa fa-remove"/>
                                                </p:commandLink>
                                            </h:panelGroup>
                                            <p:outputLabel>Hazard Activity:</p:outputLabel>
                                            <p:selectCheckboxMenu class="searchInput" id="HAInput" value="#{hazardView_MB.selectedHazardActivities}" label="Hazard Activities" filter="true" filterMatchMode="contains">
                                                <f:selectItems value="#{hazardView_MB.listHazardActivities}" var="hazardActivity" itemLabel="#{hazardActivity.activityName}" itemValue="#{hazardActivity.activityId}"/>
                                            </p:selectCheckboxMenu>
                                            <h:panelGroup styleClass="remove">
                                                <p:commandLink id="HAClear" update="hazardsForm:fieldset" action="#{hazardView_MB.clearField(component.id)}" process="@this" rendered="#{not empty hazardView_MB.selectedHazardActivities}"> 
                                                    <i class="fa fa-remove"/>
                                                </p:commandLink>
                                            </h:panelGroup>
                                            <p:outputLabel>Hazard Context:</p:outputLabel>
                                            <p:selectCheckboxMenu class="searchInput" id="HCInput" value="#{hazardView_MB.selectedHazardContexts}" label="Hazard Contexts" filter="true" filterMatchMode="contains">
                                                <f:selectItems value="#{hazardView_MB.listHazardContexts}" var="hazardContext" itemLabel="#{hazardContext.hazardContextName}" itemValue="#{hazardContext.hazardContextId}"/>
                                            </p:selectCheckboxMenu>
                                            <h:panelGroup styleClass="remove">
                                                <p:commandLink id="HCClear" update="hazardsForm:fieldset" action="#{hazardView_MB.clearField(component.id)}" process="@this" rendered="#{not empty hazardView_MB.selectedHazardContexts}"> 
                                                    <i class="fa fa-remove"/>
                                                </p:commandLink>
                                            </h:panelGroup>
                                            <p:outputLabel>Hazard Type:</p:outputLabel>
                                            <p:selectCheckboxMenu class="searchInput" id="HTInput" value="#{hazardView_MB.selectedHazardTypes}" label="Hazard Types" filter="true" filterMatchMode="contains">
                                                <f:selectItems value="#{hazardView_MB.listHazardTypes}" var="hazardType" itemLabel="#{hazardType.hazardTypeName}" itemValue="#{hazardType.hazardTypeId}"/>
                                            </p:selectCheckboxMenu>
                                            <h:panelGroup styleClass="remove">
                                                <p:commandLink id="HTClear" update="hazardsForm:fieldset" action="#{hazardView_MB.clearField(component.id)}" process="@this" rendered="#{not empty hazardView_MB.selectedHazardTypes}"> 
                                                    <i class="fa fa-remove"/>
                                                </p:commandLink>
                                            </h:panelGroup>
                                            <p:outputLabel>Hazard Status:</p:outputLabel>
                                            <p:selectCheckboxMenu class="searchInput" id="HSInput" value="#{hazardView_MB.selectedHazardStatuses}" label="Hazard Statuses" filter="true" filterMatchMode="contains">
                                                <f:selectItems value="#{hazardView_MB.listHazardStatuses}" var="hazardStatus" itemLabel="#{hazardStatus.hazardStatusName}" itemValue="#{hazardStatus.hazardStatusId}"/>
                                            </p:selectCheckboxMenu>
                                            <h:panelGroup styleClass="remove">
                                                <p:commandLink id="HSClear" update="hazardsForm:fieldset" action="#{hazardView_MB.clearField(component.id)}" process="@this" rendered="#{not empty hazardView_MB.selectedHazardStatuses}"> 
                                                    <i class="fa fa-remove"/>
                                                </p:commandLink>
                                            </h:panelGroup>
                                            <p:outputLabel>Hazard Owner:</p:outputLabel>
                                            <p:selectCheckboxMenu class="searchInput" id="HOInput" value="#{hazardView_MB.selectedHazardOwners}" label="Hazard Owners" filter="true" filterMatchMode="contains">
                                                <f:selectItems value="#{hazardView_MB.listHazardOwners}" var="hazardOwner" itemLabel="#{hazardOwner.ownerName}" itemValue="#{hazardOwner.ownerId}"/>
                                            </p:selectCheckboxMenu>
                                            <h:panelGroup styleClass="remove">
                                                <p:commandLink id="HOClear" update="hazardsForm:fieldset" action="#{hazardView_MB.clearField(component.id)}" process="@this" rendered="#{not empty hazardView_MB.selectedHazardOwners}"> 
                                                    <i class="fa fa-remove"/>
                                                </p:commandLink>
                                            </h:panelGroup>
                                        </p:panelGrid>
                                    </p:panel>
                                </p:tab>
                                <p:tab title="System Breakdown Structure Codes">
                                    <p:tree value="#{trees_MB.root}" var="doc"
                                            selectionMode="checkbox"
                                            selection="#{hazardView_MB.TNSelectedNodes}">
                                        <p:treeNode>
                                            <h:outputText value="#{doc}"/>
                                        </p:treeNode>
                                    </p:tree>
                                </p:tab>
                                <p:tab title="Control Fields">
                                    <p:panel styleClass="searchPanel">
                                        <p:panelGrid columns="3" columnClasses="left,middle,right">
                                            <p:outputLabel>Control Description:</p:outputLabel>
                                            <p:inputText value="#{hazardView_MB.searchedControlDescription}">
                                                <p:ajax event="keyup" update="CDClear"/>
                                            </p:inputText>
                                            <h:panelGroup styleClass="remove">
                                                <p:commandLink id="CDClear" update="hazardsForm:fieldset" action="#{hazardView_MB.clearField(component.id)}" process="@this" rendered="#{not empty hazardView_MB.searchedControlDescription}"> 
                                                    <i class="fa fa-remove"/>
                                                </p:commandLink>
                                            </h:panelGroup>
                                            <p:outputLabel>Control Justification:</p:outputLabel>
                                            <p:inputText value="#{hazardView_MB.searchedControlJustification}">
                                                <p:ajax event="keyup" update="CJClear"/>
                                            </p:inputText>
                                            <h:panelGroup styleClass="remove">
                                                <p:commandLink id="CJClear" update="hazardsForm:fieldset" action="#{hazardView_MB.clearField(component.id)}" process="@this" rendered="#{not empty hazardView_MB.searchedControlJustification}"> 
                                                    <i class="fa fa-remove"/>
                                                </p:commandLink>
                                            </h:panelGroup>
                                            <p:outputLabel>Control Hierarchy:</p:outputLabel>
                                            <p:selectCheckboxMenu class="searchInput" id="CHMenu" value="#{hazardView_MB.selectedControlHierachies}" label="Hierarchy" filter="true" filterMatchMode="contains">
                                                <f:selectItems value="#{hazardView_MB.listControlHierarchies}" var="controlHier" itemLabel="#{controlHier.controlHierarchyName}" itemValue="#{controlHier.controlHierarchyId}"/>
                                            </p:selectCheckboxMenu>
                                            <h:panelGroup styleClass="remove">
                                                <p:commandLink id="CTClear" update="hazardsForm:fieldset" action="#{hazardView_MB.clearField(component.id)}" process="@this" rendered="#{not empty hazardView_MB.selectedControlHierachies}"> 
                                                    <i class="fa fa-remove"/>
                                                </p:commandLink>
                                            </h:panelGroup>
                                            <p:outputLabel>Control Owner:</p:outputLabel>
                                            <p:selectCheckboxMenu class="searchInput" id="COMenu" value="#{hazardView_MB.selectedControlOwners}" label="Owners" filter="true" filterMatchMode="contains">
                                                <f:selectItems value="#{hazardView_MB.listHazardOwners}" var="controlOwner" itemLabel="#{controlOwner.ownerName}" itemValue="#{controlOwner.ownerId}"/>
                                            </p:selectCheckboxMenu>
                                            <h:panelGroup styleClass="remove">
                                                <p:commandLink id="COClear" update="hazardsForm:fieldset" action="#{hazardView_MB.clearField(component.id)}" process="@this" rendered="#{not empty hazardView_MB.selectedControlOwners}"> 
                                                    <i class="fa fa-remove"/>
                                                </p:commandLink>
                                            </h:panelGroup>
                                            <p:outputLabel>Control Recommendation:</p:outputLabel>
                                            <p:selectCheckboxMenu class="searchInput" id="CRMenu" value="#{hazardView_MB.selectedControlRecommendations}" label="Recommendations" filter="true" filterMatchMode="contains">
                                                <f:selectItems value="#{hazardView_MB.listControlRecommendations}" var="controlRecommendation" itemLabel="#{controlRecommendation.controlRecommendName}" itemValue="#{controlRecommendation.controlRecommendId}"/>
                                            </p:selectCheckboxMenu>
                                            <h:panelGroup styleClass="remove">
                                                <p:commandLink id="CRClear" update="hazardsForm:fieldset" action="#{hazardView_MB.clearField(component.id)}" process="@this" rendered="#{not empty hazardView_MB.selectedControlRecommendations}"> 
                                                    <i class="fa fa-remove"/>
                                                </p:commandLink>
                                            </h:panelGroup>
                                        </p:panelGrid>
                                    </p:panel>
                                </p:tab>
                                <p:tab title="Data Quality">
                                    <p:panel styleClass="searchPanel">
                                        <p:panelGrid columns="3" columnClasses="left,middle,right">
                                            <p:outputLabel for="dataQuality" value="Hazard Quality:"/>
                                            <p:selectOneRadio id="dataQuality" value="#{hazardView_MB.hazardsQuality}" layout="grid" columns="1">
                                                <f:selectItem id="allHazardsOption" itemLabel="All hazards" itemValue="A"/>
                                                <f:selectItem id="completeHazardsOption" itemLabel="Complete hazards" itemValue="C"/>
                                                <f:selectItem id="incompleteHazardsOption" itemLabel="Incomplete hazards" itemValue="I"/>
                                            </p:selectOneRadio>
                                        </p:panelGrid>  
                                    </p:panel>
                                </p:tab>
                            </p:accordionPanel>
                            <p:panel styleClass="queryDescr" visible="#{hazardView_MB.enableQueryDescr}">
                                <h:outputText value="#{hazardView_MB.htmlCode}" escape="false"/>
                            </p:panel>
                        </h:panelGrid>
                    </p:fieldset>
                    <div class="panelButtons">
                        <p:commandButton value="Search Hazards" action="#{hazardView_MB.constructSearchObject()}" update="hazardsForm" onstart="PF('spinnerOverlay').show()" oncomplete="PF('spinnerOverlay').hide()"/>
                        <p:commandButton value="Reset Fields" update="hazardsForm:fieldset" process="@this" action="#{hazardView_MB.resetFields()}">
                            <p:resetInput target="hazardsForm:fieldset"/>
                        </p:commandButton>
                    </div>
                    <p:dataTable id="hazardsTable" value="#{hazardView_MB.listSearchedHazards}" var="hazard" emptyMessage="No hazard entries found with given criteria. Adjust parameters and click 'Search Hazards' to begin." 
                                 scrollable="true" scrollHeight="600" scrollRows="100" liveScroll="true" styleClass="resultPanel" rowIndexVar="rowIndex" rowKey="#{hazard.hazardObj.hazardId}" selection="#{hazardView_MB.checkedHazards}" rowSelectMode="checkbox" >
                        <f:facet name="header">
                            <p:outputPanel styleClass="tableHeader">
                                <div class="left"></div>
                                <div class="center">
                                    <h:outputText value="The current hazards are: "/>
                                </div>
                                <div class="right">
                                    <h:outputText id="exportMessage" value="Export #{hazardView_MB.checkedHazards.size()} #{hazardView_MB.checkedHazards.size() == 1 ? 'hazard' : hazardView_MB.checkedHazards.size() == 0 ? 'hazards' : empty hazardView_MB.checkedHazards ? 'no hazards' : 'hazards'}: "/>
                                    <p:commandButton id="exportButton" actionListener="#{hazardView_MB.exportExcel()}" ajax="false" disabled="#{hazardView_MB.checkedHazards.size() == 0 ? true : empty hazardView_MB.checkedHazards ? true : false}" icon="fa fa-download" onstart="PF('spinnerOverlay').show()" oncomplete="PF('spinnerOverlay').hide()"/> 
                                </div>
                            </p:outputPanel>
                        </f:facet>
                        <p:ajax event="rowSelect"  update="exportMessage, exportButton" listener="#{hazardView_MB.unSelectAll()}" process="@this"/>
                        <p:ajax event="rowUnselect" update="exportMessage, exportButton" listener="#{hazardView_MB.unSelectAll()}" process="@this"/>
                        <p:ajax event="rowSelectCheckbox" update="exportMessage, exportButton" listener="#{hazardView_MB.unSelectAll()}" process="@this"/>
                        <p:ajax event="rowUnselectCheckbox" update="exportMessage, exportButton" listener="#{hazardView_MB.unSelectAll()}" process="@this"/>
                        <p:ajax event="toggleSelect" update="exportMessage, exportButton" listener="#{hazardView_MB.selectAll()}" process="@this"/>
                        <p:column selectionMode="multiple" style="width: 2%; text-align:center"/>
                        <p:column style="width: 5%; text-align:center">
                            <f:facet name="header">
                                <h:outputText value="Visualise"/>
                            </f:facet>
                            <p:commandLink id="missingIcon" class="missingIcon" rendered="#{empty hazard.missingInfo ? false : hazard.missingInfo}"><i class="fa fa-warning"></i></p:commandLink>
                            <p:tooltip for="missingIcon">
                                <h:outputText value="A visualisation cannot be generated since this hazard is missing causes, consequences, or controls!"/>
                            </p:tooltip>
                            <p:commandButton action="#{hazardViewVis_MB.constructObject(hazard.hazardObj.hazardId)}" update="hazardsForm:bowtieDialog" onstart="PF('spinnerOverlay').show()" oncomplete="PF('spinnerOverlay').hide(); PF('bowtieOverlay').show(); buildVis();" icon="fa fa-sitemap" rendered="#{hazard.missingInfo ? false : true}"/>
                        </p:column>
                        <p:column style="width: 5%; text-align:center" headerText="Rating">
                            <h:outputText>
                                <f:event type="preRenderComponent" listener="#{hazardView_MB.setQualityRating(hazardView_MB.getHazardRating(hazard.hazardObj.hazardId))}"/>
                                </h:outputText>
                            <p:rating id="averageRating" stars="3" cancel="false" value="#{hazardView_MB.qualityRating}" >
                                <p:ajax event="rate" ignoreAutoUpdate="true" listener="#{hazardView_MB.prepareRating(hazard.hazardObj.hazardId, rowIndex, hazard.sumOfRateTimesWeighting, hazard.sumOfWeight, hazard.rateCount)}" oncomplete="PF('ratingOverlay').show('#{component.clientId}');"/>
                            </p:rating>
                            <p:tooltip for="averageRating">
                                <h:outputText value="Rated #{hazardView_MB.qualityRating} from #{hazard.rateCount} users."/>
                            </p:tooltip>
                            <p:commandLink id="ratedIcon" class="ratedIcon" rendered="#{hazardView_MB.userRating == 0 ? false : true}"><i class="fa fa-check-circle"></i></p:commandLink>
                            <p:tooltip for="ratedIcon">
                                <h:outputText value="You have rated this hazard."/>
                            </p:tooltip>
                        </p:column>
                        <p:column style="width: 4%; text-align:center" headerText="Tagging">
                            <p:menuButton icon="fa fa-tag" id="tagButton">
                                <p:menuitem id="suggestionButton" value="Suggest a change" actionListener="#{hazardView_MB.setDetailHazard(hazard.hazardObj)}" oncomplete="PF('suggestionOverlay').show('#{component.clientId}')" icon="fa fa-pencil"/>
                                <p:menuitem id="deletionButton" value="Mark for deletion" actionListener="#{hazardView_MB.setDetailHazard(hazard.hazardObj)}" oncomplete="PF('deletionOverlay').show('#{component.clientId}')" icon="fa fa-trash"/>
                            </p:menuButton>
                            <p:tooltip for="tagButton">
                                <h:outputText value="Tag a change or mark for deletion"/>
                            </p:tooltip>
                        </p:column>
                        <p:column style="width: 7%; text-align:center">
                            <f:facet name="header">
                                <h:outputText value="Hazard ID"/>
                            </f:facet>
                            <p:commandLink id="viewLink" update="hazardsForm:detailDialog" actionListener="#{hazardDetail_MB.showDetail(hazard.hazardObj.hazardId)}" onstart="PF('spinnerOverlay').show()" oncomplete="PF('spinnerOverlay').hide(); PF('detailOverlay').show()">
                                <h:outputText value="#{hazard.hazardObj.hazardId}"/>
                            </p:commandLink>
                            <p:tooltip for="viewLink">
                                <i class="fa fa-search"/>
                                <h:outputText value=" View Hazard"/>
                            </p:tooltip>
                        </p:column>
                        <p:column style="width: 22%">
                            <f:facet name="header">
                                <h:outputText value="Description"/>
                            </f:facet>
                            <h:outputText value="#{hazard.hazardObj.hazardDescription}"/>
                        </p:column>
                        <p:column style="width: 22%">
                            <f:facet name="header">
                                <h:outputText value="Comment"/>
                            </f:facet>
                            <h:outputText value="#{hazard.hazardObj.hazardComment}"/>
                        </p:column>
                        <p:column style="width: 6%">
                            <f:facet name="header">
                                <h:outputText value="Context"/>
                            </f:facet>
                            <h:outputText value="#{hazard.hazardObj.hazardContextId.hazardContextName}"/>
                        </p:column>
                        <p:column style="width: 6.5%">
                            <f:facet name="header">
                                <h:outputText value="Location"/>
                            </f:facet>
                            <h:outputText value="#{hazard.hazardObj.hazardLocation.locationName}"/>
                        </p:column>
                        <p:column style="width: 7%">
                            <f:facet name="header">
                                <h:outputText value="Activity"/>
                            </f:facet>
                            <h:outputText value="#{hazard.hazardObj.hazardActivity.activityName}"/>
                        </p:column>
                        <p:column style="width: 6%">
                            <f:facet name="header">
                                <h:outputText value="Type"/>
                            </f:facet>
                            <h:outputText value="#{hazard.hazardObj.hazardTypeId.hazardTypeName}"/>
                        </p:column>
                        <p:column style="width: 6.5%">
                            <f:facet name="header">
                                <h:outputText value="Status"/>
                            </f:facet>
                            <h:outputText value="#{hazard.hazardObj.hazardStatusId.hazardStatusName}"/>
                        </p:column>
                        <p:column style="width: 7%">
                            <f:facet name="header">
                                <h:outputText value="Owner"/>
                            </f:facet>
                            <h:outputText value="#{hazard.hazardObj.ownerId.ownerName}"/>
                        </p:column>
                        <f:facet name="footer">
                            <p:outputPanel>
                                <h:outputText value="Showing #{hazardView_MB.listSearchedHazards.size()} #{hazardView_MB.listSearchedHazards.size() == 1 ? 'hazard' : hazardView_MB.listSearchedHazards.size() == 0 ? 'hazards' : empty hazardView_MB.listSearchedHazards ? 'no hazards' : 'hazards'}"/>
                            </p:outputPanel>
                        </f:facet>
                    </p:dataTable>
                    <p:overlayPanel my="top right" at="top right" class="ratingPanel" widgetVar="ratingOverlay" hideEffect="fade" dismissable="false" showCloseIcon="false">
                        <p:commandLink id="averageRating" class="averageRating">
                            <h:outputText value="#{hazardView_MB.averageRating}"/>
                        </p:commandLink><br/>
                        <p:commandLink id="countRating" class="countRating">
                            <i class="fa fa-user"/><h:outputText value=" #{hazardView_MB.ratingCount} total"/>
                        </p:commandLink>
                        <p:tooltip id="averageTooltip" for="averageRating">
                            <h:outputText value="Average rating"/>
                        </p:tooltip>
                        <p:tooltip id="countTooltip" for="countRating">
                            <h:outputText value="Number of ratings"/>
                        </p:tooltip><br/>
                        <h:outputText value="Your rating:" style="font-size: 1.2em;"/>
                        <p:rating id="userRating" value="#{hazardView_MB.userRating}" stars="3" cancel="false">
                            <p:ajax event="rate" listener="#{hazardView_MB.rateHazard(hazardView_MB.ratingId, hazardView_MB.userRating)}" update="hazardsForm:averageRating, hazardsForm:countRating, hazardsForm:averageTooltip, hazardsForm:countTooltip">
                                <f:attribute name="hazardId" value="#{hazard.hazardObj}"/>
                            </p:ajax>
                        </p:rating>
                    </p:overlayPanel>
                    <p:overlayPanel widgetVar="suggestionOverlay" hideEffect="fade" dismissable="false" showCloseIcon="true" >
                        <p:panelGrid columns="1" class="suggestionPanel">
                            <f:facet name="header">
                                <h:outputText value="Suggest a change"/>
                            </f:facet>
                            <h:outputText value="Leave a comment:"/>
                            <p:inputTextarea id="suggestionComments" value="#{hazardView_MB.suggestionComment}"/>
                            <p:commandButton value="Send" actionListener="#{hazardView_MB.sendSuggestion()}" update="suggestionComments" oncomplete="PF('suggestionOverlay').hide()"/>
                        </p:panelGrid>
                    </p:overlayPanel>
                    <p:overlayPanel widgetVar="deletionOverlay" hideEffect="fade" dismissable="false" showCloseIcon="true">
                        <p:panelGrid columns="1" class="suggestionPanel">
                            <f:facet name="header">
                                <h:outputText value="Mark for deletion"/>
                            </f:facet>
                            <h:outputText value="Leave a comment:"/>
                            <p:inputTextarea id="deletionComments" value="#{hazardView_MB.deletionComment}"/>
                        </p:panelGrid>
                        <p:panelGrid columns="2" class="suggestionPanel">
                            <p:selectOneMenu id="deletionReason" value="#{hazardView_MB.deletionReason}">
                                <f:selectItem itemLabel="Duplicate" itemValue="Duplicate"/>
                                <f:selectItem itemLabel="Poor Quality" itemValue="Poor Quality"/>
                                <f:selectItem itemLabel="Other (see comment)" itemValue="Other (see comment)"/>
                            </p:selectOneMenu>
                            <p:commandButton value="Send" actionListener="#{hazardView_MB.sendDeletion()}" update="deletionComments, deletionReason" oncomplete="PF('deletionOverlay').hide()"/>
                        </p:panelGrid>
                    </p:overlayPanel>
                </h:form>
                <script type="text/javascript" src="../../resources/js/svg.min.js"/>
                <script type="text/javascript" src="../../resources/js/viewVis.js"/>
                <script type="text/javascript">
                    function closeRating() {
                        PF('ratingOverlay').hide();
                    }
                </script>
            </ui:define>
        </ui:composition>
    </body>
</html>
